# Antidote-based plugin loader (lightweight, fast)
# This file is sourced by ~/.zshrc

# Install Antidote if missing
if [[ ! -d "${HOME}/.antidote" ]]; then
  git clone --depth=1 https://github.com/mattmc3/antidote "${HOME}/.antidote" >/dev/null 2>&1
fi

# Load Antidote
if [[ -r "${HOME}/.antidote/antidote.zsh" ]]; then
  source "${HOME}/.antidote/antidote.zsh"
else
  # Fallback: no plugin manager available; exit early to keep shell usable
  return 0
fi

# Determine terminal
_term_prog="${TERM_PROGRAM:-}"

# Feature toggles
# LIGHT_SHELL=1 -> skip heavier visual plugins (syntax highlighting)
# WARP_USE_ZSH_AUTOSUGGEST=0 in Warp -> disable autosuggestions inside Warp

## Plugins file management (on-change write)
# Build plugin list dynamically per shell, then update ~/.zsh_plugins.txt only if contents changed.
_dotfiles_repo_path=$(chezmoi source-path)
_base_zsh_plugins="${_dotfiles_repo_path}/.zsh_plugins.txt.base"
_zsh_plugins_file="${HOME}/.zsh_plugins.txt"
_zsh_plugins_tmp="${_zsh_plugins_file}.new"

# initialize as empty array so later `plugins+=(...)` appends work
plugins=()

# Autosuggestions (unless explicitly disabled in Warp)
if [[ "${_term_prog}" != "WarpTerminal" || "${WARP_USE_ZSH_AUTOSUGGEST}" == "1" ]]; then
  plugins+=( zsh-users/zsh-autosuggestions )
fi

# Syntax highlighting unless LIGHT_SHELL=1
if [[ "${LIGHT_SHELL:-0}" != "1" ]]; then
  plugins+=( zdharma-continuum/fast-syntax-highlighting )
fi

# Write to temp file
{
  if [[ -r "${_base_zsh_plugins}" ]]; then
    cat "${_base_zsh_plugins}" 2>/dev/null || :
  fi
  printf '%s\n' "${plugins[@]}"
} >"${_zsh_plugins_tmp}" 2>/dev/null || :

# Replace target only if different (avoids unnecessary writes)
if [[ -s "${_zsh_plugins_tmp}" ]]; then
  if ! cmp -s "${_zsh_plugins_tmp}" "${_zsh_plugins_file}" 2>/dev/null; then
    mv -f "${_zsh_plugins_tmp}" "${_zsh_plugins_file}" 2>/dev/null || rm -f "${_zsh_plugins_tmp}" 2>/dev/null
  else
    rm -f "${_zsh_plugins_tmp}" 2>/dev/null
  fi
else
  rm -f "${_zsh_plugins_tmp}" 2>/dev/null
fi

unset -v _dotfiles_repo_path _base_zsh_plugins _zsh_plugins_file _zsh_plugins_tmp

# Load plugins (reads ~/.zsh_plugins.txt)
antidote load

# Autosuggestion tuning (no-op if plugin disabled)
export ZSH_AUTOSUGGEST_STRATEGY=(history completion)
export ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=40
: "${ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE:=fg=245}" # default subtly gray

# Cleanup
unset -v _term_prog plugins
